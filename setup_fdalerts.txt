#!/bin/bash
set -e

echo "======================================="
echo " 🚀 FD Alerts Setup Utility"
echo "======================================="

read -p "🔢 Ποια πόρτα θέλεις να χρησιμοποιήσεις; (default 8899): " PORT
PORT=${PORT:-8899}

INSTALL_DIR="/opt/raspipush_ultimate"
SERVICE_FILE="/etc/systemd/system/raspipush_ultimate.service"

echo "📦 Δημιουργία φακέλων..."
sudo mkdir -p $INSTALL_DIR/static/icons
cd $INSTALL_DIR

echo "📁 Αντιγραφή αρχείων εφαρμογής..."
sudo curl -sSL https://raw.githubusercontent.com/maxsto73/fdalerts-installer/main/app.py -o app.py

echo "📦 Δημιουργία εικονικού περιβάλλοντος..."
sudo apt-get update -y
sudo apt-get install -y python3 python3-venv python3-pip
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip flask requests

echo "⚙️ Δημιουργία υπηρεσίας systemd..."
sudo tee $SERVICE_FILE > /dev/null <<EOF
[Unit]
Description=RasPi Notifications Ultimate (Flask) on port $PORT
After=network.target

[Service]
ExecStart=$INSTALL_DIR/venv/bin/python $INSTALL_DIR/app.py
WorkingDirectory=$INSTALL_DIR
Restart=always
Environment="PORT=$PORT"
Environment="YUBOTO_API_KEY=MDBCNDZFQTktREI1MS00NUMxLUEzRTktOTY3RTQ0NURGNjA1"
Environment="YUBOTO_SENDER=FDTeam 2012"
Environment="PUBLIC_BASE_URL=https://app.fdteam2012.gr"
User=root

[Install]
WantedBy=multi-user.target
EOF

echo "🔁 Επανεκκίνηση υπηρεσίας..."
sudo systemctl daemon-reload
sudo systemctl enable raspipush_ultimate.service
sudo systemctl restart raspipush_ultimate.service

echo "✅ Εγκατάσταση ολοκληρώθηκε!"
echo "➡️ Άνοιξε: http://$(hostname -I | awk '{print $1}'):$PORT"
