#!/bin/bash
set -e

echo "======================================="
echo " 🚀 FD Alerts Setup Utility"
echo "    (Installer / Uninstaller / Update)"
echo "======================================="
echo ""

ACTION="$1"

case "$ACTION" in
  install)
    echo "🔧 Ξεκινά η εγκατάσταση FD Alerts..."
    echo ""
    
    # Ζήτα port από τον χρήστη
    read -rp "➡️  Δώσε θύρα για το web interface (προεπιλογή 8899): " PORT
    PORT=${PORT:-8899}
    echo "📡 Επιλέχθηκε θύρα: $PORT"
    echo ""
    
    # Εγκατάσταση εξαρτήσεων
    sudo apt-get update -y
    sudo apt-get install -y python3 python3-venv python3-pip

    # Δημιουργία φακέλου εφαρμογής
    sudo mkdir -p /opt/raspipush_ultimate
    cd /opt/raspipush_ultimate

    # Δημιουργία virtual environment
    sudo python3 -m venv venv
    source venv/bin/activate

    # Εγκατάσταση Flask & Requests
    pip install --upgrade pip
    pip install flask requests

    # Δημιουργία βασικού app.py
    cat <<EOF | sudo tee /opt/raspipush_ultimate/app.py > /dev/null
from flask import Flask, request, jsonify
import requests

app = Flask(__name__)

@app.route('/')
def home():
    return '<h2>FD Alerts is running on port ${PORT} 🎉</h2>'

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=${PORT})
EOF

    # Δημιουργία systemd service
    sudo tee /etc/systemd/system/raspipush_ultimate.service > /dev/null <<SERVICE
[Unit]
Description=RasPi Notifications Ultimate (Flask) on port ${PORT}
After=network.target

[Service]
ExecStart=/opt/raspipush_ultimate/venv/bin/python /opt/raspipush_ultimate/app.py
WorkingDirectory=/opt/raspipush_ultimate
Restart=always
User=pi

[Install]
WantedBy=multi-user.target
SERVICE

    sudo systemctl daemon-reload
    sudo systemctl enable raspipush_ultimate.service
    sudo systemctl restart raspipush_ultimate.service

    echo ""
    echo "✅ Εγκατάσταση ολοκληρώθηκε!"
    echo "🌐 Άνοιξε: http://$(hostname -I | awk '{print $1}'):${PORT}"
    ;;
  
  uninstall)
    echo "🧹 Απεγκατάσταση FD Alerts..."
    sudo systemctl stop raspipush_ultimate.service || true
    sudo systemctl disable raspipush_ultimate.service || true
    sudo rm -f /etc/systemd/system/raspipush_ultimate.service
    sudo rm -rf /opt/raspipush_ultimate
    sudo systemctl daemon-reload
    echo "✅ Ολοκληρώθηκε η απεγκατάσταση."
    ;;
  
  *)
    echo "Χρήση: sudo bash setup_fdalerts.txt [install|uninstall]"
    exit 1
    ;;
esac
