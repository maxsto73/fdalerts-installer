#!/bin/bash
# ==========================================================
#  FD Alerts â€” Automatic Installer / Uninstaller / Updater
# ==========================================================

APP_DIR="/opt/raspipush_ultimate"
SERVICE_NAME="raspipush_ultimate.service"
REPO_BASE="https://raw.githubusercontent.com/maxsto73/fdalerts-installer/main"

echo "======================================="
echo " ðŸš€ FD Alerts Setup Utility"
echo "    (Installer / Uninstaller / Update)"
echo "======================================="
echo ""

read -p "ðŸ‘‰ Î•Ï€Î¹Î»Î¿Î³Î® (1=Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·, 2=Î‘Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·, 3=Î•Ï€Î±Î½ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·): " CHOICE

# ----------------------------------------------------------
# Î‘Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·
# ----------------------------------------------------------
if [ "$CHOICE" == "2" ]; then
    echo "ðŸ§¹ Î‘Ï€ÎµÎ³ÎºÎ±Î¸Î¯ÏƒÏ„Î±Ï„Î±Î¹ FD Alerts..."
    sudo systemctl stop $SERVICE_NAME 2>/dev/null
    sudo systemctl disable $SERVICE_NAME 2>/dev/null
    sudo rm -rf $APP_DIR
    sudo rm -f /etc/systemd/system/$SERVICE_NAME
    echo "âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏŽÎ¸Î·ÎºÎµ Î· Î±Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·."
    exit 0
fi

# ----------------------------------------------------------
# Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î® Î•Ï€Î±Î½ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·
# ----------------------------------------------------------
echo "ðŸ”§ ÎžÎµÎºÎ¹Î½Î¬ Î· ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· FD Alerts..."
echo ""

# Î–Î®Ï„Î± Ï€ÏŒÏÏ„Î± Î±Ï€ÏŒ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î·
read -p "ðŸ”¢ Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ port (Ï€.Ï‡. 8899): " PORT
if [ -z "$PORT" ]; then
    PORT=8899
    echo "âš ï¸ Î”ÎµÎ½ Î´ÏŒÎ¸Î·ÎºÎµ Ï„Î¹Î¼Î®, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î®: 8899"
fi

# Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï†Î±ÎºÎ­Î»Î¿Ï… ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚
sudo mkdir -p $APP_DIR
cd $APP_DIR || exit 1

# ÎšÎ±Ï„Î­Î²Î±ÏƒÎµ Ï„Î¿ app.py
echo "â¬‡ï¸  Î›Î®ÏˆÎ· ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ Î±Ï€ÏŒ GitHub..."
sudo curl -sSL "$REPO_BASE/app.py" -o app.py

# Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÎ±Î¹ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Python venv
sudo apt update -y
sudo apt install -y python3 python3-venv python3-pip
sudo python3 -m venv venv
source venv/bin/activate
pip install flask requests
deactivate

# Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± systemd Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚
echo "âš™ï¸  Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± systemd service..."

sudo bash -c "cat > /etc/systemd/system/$SERVICE_NAME" <<EOF
[Unit]
Description=RasPi Notifications Ultimate (Flask) on port $PORT
After=network.target

[Service]
Environment=\"PORT=$PORT\"
WorkingDirectory=$APP_DIR
ExecStart=$APP_DIR/venv/bin/python $APP_DIR/app.py
Restart=always
User=pi

[Install]
WantedBy=multi-user.target
EOF

# Î•Ï€Î±Î½ÎµÎºÎºÎ¯Î½Î·ÏƒÎ· Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚
sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl enable $SERVICE_NAME
sudo systemctl restart $SERVICE_NAME

sleep 2
echo ""
echo "âœ… Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏŽÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏŽÏ‚!"
echo "ðŸŒ Î†Î½Î¿Î¹Î¾Îµ: http://$(hostname -I | awk '{print $1}'):$PORT"
echo ""
sudo systemctl status $SERVICE_NAME --no-pager -n 5
