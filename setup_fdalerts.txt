#!/bin/bash
set -e

echo "======================================="
echo " ğŸš€ FD Alerts Setup Utility"
echo "    (Installer / Uninstaller / Update)"
echo "======================================="
echo ""

ACTION="$1"

case "$ACTION" in
  install)
    echo "ğŸ”§ ÎÎµÎºÎ¹Î½Î¬ Î· ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· FD Alerts..."
    echo ""
    
    # Î–Î®Ï„Î± port Î±Ï€ÏŒ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î·
    read -rp "â¡ï¸  Î”ÏÏƒÎµ Î¸ÏÏÎ± Î³Î¹Î± Ï„Î¿ web interface (Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î® 8899): " PORT
    PORT=${PORT:-8899}
    echo "ğŸ“¡ Î•Ï€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ Î¸ÏÏÎ±: $PORT"
    echo ""
    
    # Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÎµÎ¾Î±ÏÏ„Î®ÏƒÎµÏ‰Î½
    sudo apt-get update -y
    sudo apt-get install -y python3 python3-venv python3-pip

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï†Î±ÎºÎ­Î»Î¿Ï… ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚
    sudo mkdir -p /opt/raspipush_ultimate
    cd /opt/raspipush_ultimate

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± virtual environment
    sudo python3 -m venv venv
    source venv/bin/activate

    # Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Flask & Requests
    pip install --upgrade pip
    pip install flask requests

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î²Î±ÏƒÎ¹ÎºÎ¿Ï app.py
    cat <<EOF | sudo tee /opt/raspipush_ultimate/app.py > /dev/null
from flask import Flask, request, jsonify
import requests

app = Flask(__name__)

@app.route('/')
def home():
    return '<h2>FD Alerts is running on port ${PORT} ğŸ‰</h2>'

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=${PORT})
EOF

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± systemd service
    sudo tee /etc/systemd/system/raspipush_ultimate.service > /dev/null <<SERVICE
[Unit]
Description=RasPi Notifications Ultimate (Flask) on port ${PORT}
After=network.target

[Service]
ExecStart=/opt/raspipush_ultimate/venv/bin/python /opt/raspipush_ultimate/app.py
WorkingDirectory=/opt/raspipush_ultimate
Restart=always
User=pi

[Install]
WantedBy=multi-user.target
SERVICE

    sudo systemctl daemon-reload
    sudo systemctl enable raspipush_ultimate.service
    sudo systemctl restart raspipush_ultimate.service

    echo ""
    echo "âœ… Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ!"
    echo "ğŸŒ Î†Î½Î¿Î¹Î¾Îµ: http://$(hostname -I | awk '{print $1}'):${PORT}"
    ;;
  
  uninstall)
    echo "ğŸ§¹ Î‘Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· FD Alerts..."
    sudo systemctl stop raspipush_ultimate.service || true
    sudo systemctl disable raspipush_ultimate.service || true
    sudo rm -f /etc/systemd/system/raspipush_ultimate.service
    sudo rm -rf /opt/raspipush_ultimate
    sudo systemctl daemon-reload
    echo "âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ Î· Î±Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·."
    ;;
  
  *)
    echo "Î§ÏÎ®ÏƒÎ·: sudo bash setup_fdalerts.txt [install|uninstall]"
    exit 1
    ;;
esac
