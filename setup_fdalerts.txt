#!/bin/bash
set -e

APP_DIR="/opt/raspipush_ultimate"
SERVICE_NAME="fdalerts.service"
REPO_BASE="https://raw.githubusercontent.com/maxsto73/fdalerts-installer/main"

clear
echo "======================================="
echo " ðŸš€ FD Alerts Setup Utility"
echo "    (Installer / Uninstaller / Update)"
echo "======================================="
echo ""

echo "ðŸ‘‰ Î•Ï€Î¹Î»Î¿Î³Î® (1=Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·, 2=Î‘Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·, 3=Î•Ï€Î±Î½ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·): "
read -r CHOICE

# ----------------------------------------------------------
# Î‘Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·
# ----------------------------------------------------------
if [ "$CHOICE" = "2" ]; then
    echo "ðŸ§¹ Î‘Ï€ÎµÎ³ÎºÎ±Î¸Î¯ÏƒÏ„Î±Ï„Î±Î¹ FD Alerts..."
    sudo systemctl stop $SERVICE_NAME 2>/dev/null || true
    sudo systemctl disable $SERVICE_NAME 2>/dev/null || true
    sudo rm -f /etc/systemd/system/$SERVICE_NAME
    sudo rm -rf $APP_DIR
    sudo systemctl daemon-reload
    echo "âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏŽÎ¸Î·ÎºÎµ Î· Î±Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·."
    exit 0
fi

# ----------------------------------------------------------
# Î•Ï€Î±Î½ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·
# ----------------------------------------------------------
if [ "$CHOICE" = "3" ]; then
    echo "ðŸ” Î•Ï€Î±Î½ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·..."
    sudo systemctl stop $SERVICE_NAME 2>/dev/null || true
    sudo rm -rf $APP_DIR
    sudo systemctl disable $SERVICE_NAME 2>/dev/null || true
    sudo rm -f /etc/systemd/system/$SERVICE_NAME
    sudo systemctl daemon-reload
    CHOICE="1"
fi

# ----------------------------------------------------------
# Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·
# ----------------------------------------------------------
if [ "$CHOICE" = "1" ]; then
    echo ""
    echo "ðŸ”§ ÎžÎµÎºÎ¹Î½Î¬ Î· ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· FD Alerts..."
    echo ""
    read -p "ðŸ”¢ Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ port (Ï€.Ï‡. 8899): " PORT
    if [ -z "$PORT" ]; then
        PORT=8899
        echo "âš ï¸ Î”ÎµÎ½ Î´ÏŒÎ¸Î·ÎºÎµ Ï„Î¹Î¼Î®, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î®: 8899"
    fi

    echo "â¬‡ï¸  Î›Î®ÏˆÎ· ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ Î±Ï€ÏŒ GitHub..."
    sudo mkdir -p "$APP_DIR"
    sudo chown -R pi:pi "$APP_DIR"
    cd "$APP_DIR" || exit 1

    curl -sSL "$REPO_BASE/app.py" -o app.py

    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± log file
    echo "ðŸª¶ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î±ÏÏ‡ÎµÎ¯Î¿Ï… log..."
    sudo mkdir -p "$APP_DIR"
    sudo touch "$APP_DIR/fdalerts.log"
    sudo chown -R pi:pi "$APP_DIR"

    echo "ðŸ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Python virtual environment..."
    sudo apt update -y && sudo apt install -y python3 python3-venv python3-pip
    python3 -m venv venv
    source venv/bin/activate
    pip install --break-system-packages flask requests
    deactivate

    echo "âš™ï¸  Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± systemd service..."
    sudo bash -c "cat > /etc/systemd/system/$SERVICE_NAME" <<EOF
[Unit]
Description=FD Alerts Flask Service on port $PORT
After=network.target

[Service]
Environment="PORT=$PORT"
WorkingDirectory=$APP_DIR
ExecStart=$APP_DIR/venv/bin/python $APP_DIR/app.py
Restart=always
User=pi

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reexec
    sudo systemctl daemon-reload
    sudo systemctl enable $SERVICE_NAME
    sudo systemctl restart $SERVICE_NAME

    sleep 2
    echo ""
    echo "âœ… Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏŽÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏŽÏ‚!"
    echo "ðŸŒ Î†Î½Î¿Î¹Î¾Îµ: http://$(hostname -I | awk '{print $1}'):$PORT"
    echo ""

    if ! systemctl is-active --quiet $SERVICE_NAME; then
        echo "âš ï¸ Î¤Î¿ service Î´ÎµÎ½ Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ ÏƒÏ‰ÏƒÏ„Î¬. Î”ÎµÏ‚ Ï„Î± Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± logs:"
        sudo journalctl -u $SERVICE_NAME -n 20 --no-pager
    fi
    exit 0
fi

echo "âŒ ÎœÎ· Î­Î³ÎºÏ…ÏÎ· ÎµÏ€Î¹Î»Î¿Î³Î®. ÎˆÎ¾Î¿Î´Î¿Ï‚."
exit 1
