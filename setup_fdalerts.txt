#!/bin/bash
set -e

ACTION="$1"
APP_DIR="/opt/raspipush_ultimate"
SERVICE_FILE="/etc/systemd/system/raspipush_ultimate.service"

# === Default values ===
DEFAULT_PORT=8899
APIKEY="MDBCNDZFQTktREI1MS00NUMxLUEzRTktOTY3RTQ0NURGNjA1"
SENDER="FDTeam 2012"

clear
echo "======================================"
echo " ðŸš€ FD Alerts Setup Utility"
echo "    (Auto Install with Port Check)"
echo "======================================"
echo ""

if [[ -z "$ACTION" ]]; then
    echo "âŒ Î”ÎµÎ½ Î´ÏŒÎ¸Î·ÎºÎµ ÎµÎ½Î­ÏÎ³ÎµÎ¹Î±."
    echo "ðŸ‘‰ Î§ÏÎ®ÏƒÎ·: sudo bash setup_fdalerts.txt [install|uninstall|update]"
    exit 1
fi

# === ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Î¼Î¹Î± Ï€ÏŒÏÏ„Î± ÎµÎ¯Î½Î±Î¹ ÎµÎ»ÎµÏÎ¸ÎµÏÎ· ===
is_port_free() {
    ! sudo lsof -i -P -n | grep -q ":$1 "
}

# === Î‘Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ===
if [[ "$ACTION" == "uninstall" ]]; then
    echo "ðŸ§¹ Î‘Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· FD Alerts..."
    sudo systemctl stop raspipush_ultimate.service 2>/dev/null || true
    sudo systemctl disable raspipush_ultimate.service 2>/dev/null || true
    sudo rm -f $SERVICE_FILE
    sudo rm -rf $APP_DIR
    sudo systemctl daemon-reload
    sudo systemctl reset-failed
    echo "âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏŽÎ¸Î·ÎºÎµ Î· Î±Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·."
    exit 0
fi

# === Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ===
if [[ "$ACTION" == "update" ]]; then
    echo "â™»ï¸ Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· FD Alerts..."
    sudo systemctl stop raspipush_ultimate.service 2>/dev/null || true
    sudo curl -sSL https://www.fdteam2012.gr/raspush/app_fdalerts.py -o $APP_DIR/app.py
    sudo systemctl restart raspipush_ultimate.service
    echo "âœ… Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏŽÎ¸Î·ÎºÎµ!"
    IP=$(hostname -I | awk '{print $1}')
    PORT=$(grep "PORT=" $SERVICE_FILE | sed "s/.*PORT=\([0-9]*\).*/\1/")
    echo "ðŸŒ Î†Î½Î¿Î¹Î¾Îµ: http://${IP}:${PORT}"
    exit 0
fi

# === Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ===
if [[ "$ACTION" == "install" ]]; then
    echo "âš™ï¸ ÎžÎµÎºÎ¹Î½Î¬ ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· FD Alerts..."
    echo ""
    read -p "ðŸ‘‰ Î”ÏŽÏƒÎµ Î±ÏÎ¹Î¸Î¼ÏŒ Ï€ÏŒÏÏ„Î±Ï‚ (default: ${DEFAULT_PORT}): " PORT
    if [[ -z "$PORT" ]]; then
        PORT=$DEFAULT_PORT
    fi

    # === ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï€ÏŒÏÏ„Î±Ï‚ ===
    while ! is_port_free "$PORT"; do
        echo "âš ï¸ Î— Ï€ÏŒÏÏ„Î± $PORT Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î®Î´Î·."
        ((PORT++))
        echo "ðŸ”„ Î”Î¿ÎºÎ¹Î¼Î® ÎµÏ€ÏŒÎ¼ÎµÎ½Î·Ï‚ Ï€ÏŒÏÏ„Î±Ï‚: $PORT"
    done

    echo "âœ… Î•Ï€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ ÎµÎ»ÎµÏÎ¸ÎµÏÎ· Ï€ÏŒÏÏ„Î±: $PORT"
    echo ""
    echo "âœ‰ï¸ Sender: $SENDER"
    echo "ðŸ”‘ API Key: (Ï€ÏÎ¿ÏÏ…Î¸Î¼Î¹ÏƒÎ¼Î­Î½Î¿)"
    echo ""

    sudo apt-get update -y
    sudo apt-get install -y python3 python3-venv python3-pip curl lsof

    sudo mkdir -p $APP_DIR
    sudo chown -R $USER:$USER $APP_DIR

    cd $APP_DIR
    python3 -m venv venv
    source venv/bin/activate

    pip install --upgrade pip
    pip install flask requests

    curl -sSL https://www.fdteam2012.gr/raspush/app_fdalerts.py -o $APP_DIR/app.py

    # === Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± systemd service ===
    echo "âš™ï¸ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± systemd service..."
    sudo bash -c "cat > $SERVICE_FILE" <<EOF
[Unit]
Description=RasPi Notifications Ultimate (FD Alerts)
After=network.target

[Service]
ExecStart=$APP_DIR/venv/bin/python $APP_DIR/app.py
WorkingDirectory=$APP_DIR
Restart=always
User=pi
Environment='PORT=${PORT}'
Environment='YUBOTO_API_KEY=${APIKEY}'
Environment='SENDER_NAME=${SENDER}'
Environment='FLASK_ENV=production'

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reload
    sudo systemctl enable raspipush_ultimate.service
    sudo systemctl restart raspipush_ultimate.service

    IP=$(hostname -I | awk '{print $1}')
    echo ""
    echo "âœ… Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏŽÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏŽÏ‚!"
    echo "ðŸŒ Web Interface: http://${IP}:${PORT}"
    echo "ðŸ“¡ Î¥Ï€Î·ÏÎµÏƒÎ¯Î±: raspipush_ultimate.service"
    echo "======================================"
    exit 0
fi

echo "âŒ ÎœÎ· Î­Î³ÎºÏ…ÏÎ· ÎµÏ€Î¹Î»Î¿Î³Î®. Î§ÏÎ®ÏƒÎ·: install | uninstall | update"
exit 1

