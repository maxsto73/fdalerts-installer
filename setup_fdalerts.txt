#!/bin/bash
set -e

echo "======================================="
echo " ðŸš€ FD Alerts Setup Utility"
echo "======================================="

read -p "ðŸ”¢ Î Î¿Î¹Î± Ï€ÏŒÏÏ„Î± Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚; (default 8899): " PORT
PORT=${PORT:-8899}

INSTALL_DIR="/opt/raspipush_ultimate"
SERVICE_FILE="/etc/systemd/system/raspipush_ultimate.service"

echo "ðŸ“¦ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï†Î±ÎºÎ­Î»Ï‰Î½..."
sudo mkdir -p $INSTALL_DIR/static/icons
cd $INSTALL_DIR

echo "ðŸ“ Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® Î±ÏÏ‡ÎµÎ¯Ï‰Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚..."
sudo curl -sSL https://raw.githubusercontent.com/maxsto73/fdalerts-installer/main/app.py -o app.py

echo "ðŸ“¦ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎµÎ¹ÎºÎ¿Î½Î¹ÎºÎ¿Ï Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½Ï„Î¿Ï‚..."
sudo apt-get update -y
sudo apt-get install -y python3 python3-venv python3-pip
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip flask requests

echo "âš™ï¸ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚ systemd..."
sudo tee $SERVICE_FILE > /dev/null <<EOF
[Unit]
Description=RasPi Notifications Ultimate (Flask) on port $PORT
After=network.target

[Service]
ExecStart=$INSTALL_DIR/venv/bin/python $INSTALL_DIR/app.py
WorkingDirectory=$INSTALL_DIR
Restart=always
Environment="PORT=$PORT"
Environment="YUBOTO_API_KEY=MDBCNDZFQTktREI1MS00NUMxLUEzRTktOTY3RTQ0NURGNjA1"
Environment="YUBOTO_SENDER=FDTeam 2012"
Environment="PUBLIC_BASE_URL=https://app.fdteam2012.gr"
User=root

[Install]
WantedBy=multi-user.target
EOF

echo "ðŸ” Î•Ï€Î±Î½ÎµÎºÎºÎ¯Î½Î·ÏƒÎ· Ï…Ï€Î·ÏÎµÏƒÎ¯Î±Ï‚..."
sudo systemctl daemon-reload
sudo systemctl enable raspipush_ultimate.service
sudo systemctl restart raspipush_ultimate.service

echo "âœ… Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏŽÎ¸Î·ÎºÎµ!"
echo "âž¡ï¸ Î†Î½Î¿Î¹Î¾Îµ: http://$(hostname -I | awk '{print $1}'):$PORT"
