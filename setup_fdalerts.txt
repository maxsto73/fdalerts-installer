#!/bin/bash
set -e

APP_DIR="/opt/raspipush_ultimate"
SERVICE_NAME="fdalerts.service"
REPO_BASE="https://raw.githubusercontent.com/maxsto73/fdalerts-installer/main"

clear
echo "======================================="
echo " 🚀 FD Alerts Setup Utility"
echo "    (Installer / Uninstaller / Update)"
echo "======================================="
echo ""

echo "👉 Επιλογή (1=Εγκατάσταση, 2=Απεγκατάσταση, 3=Επανεγκατάσταση): "
read -r CHOICE

# ----------------------------------------------------------
# Απεγκατάσταση
# ----------------------------------------------------------
if [ "$CHOICE" = "2" ]; then
    echo "🧹 Απεγκαθίσταται FD Alerts..."
    sudo systemctl stop $SERVICE_NAME 2>/dev/null || true
    sudo systemctl disable $SERVICE_NAME 2>/dev/null || true
    sudo rm -f /etc/systemd/system/$SERVICE_NAME
    sudo rm -rf $APP_DIR
    sudo systemctl daemon-reload
    echo "✅ Ολοκληρώθηκε η απεγκατάσταση."
    exit 0
fi

# ----------------------------------------------------------
# Επανεγκατάσταση
# ----------------------------------------------------------
if [ "$CHOICE" = "3" ]; then
    echo "🔁 Επανεγκατάσταση..."
    sudo systemctl stop $SERVICE_NAME 2>/dev/null || true
    sudo rm -rf $APP_DIR
    sudo systemctl disable $SERVICE_NAME 2>/dev/null || true
    sudo rm -f /etc/systemd/system/$SERVICE_NAME
    sudo systemctl daemon-reload
    CHOICE="1"
fi

# ----------------------------------------------------------
# Εγκατάσταση
# ----------------------------------------------------------
if [ "$CHOICE" = "1" ]; then
    echo ""
    echo "🔧 Ξεκινά η εγκατάσταση FD Alerts..."
    echo ""
    read -p "🔢 Πληκτρολόγησε port (π.χ. 8899): " PORT
    if [ -z "$PORT" ]; then
        PORT=8899
        echo "⚠️ Δεν δόθηκε τιμή, χρησιμοποιείται προεπιλογή: 8899"
    fi

    echo "⬇️  Λήψη εφαρμογής από GitHub..."
    sudo mkdir -p "$APP_DIR"
    sudo chown -R pi:pi "$APP_DIR"
    cd "$APP_DIR" || exit 1

    curl -sSL "$REPO_BASE/app.py" -o app.py

    # Δημιουργία log file
    echo "🪶 Δημιουργία αρχείου log..."
    sudo mkdir -p "$APP_DIR"
    sudo touch "$APP_DIR/fdalerts.log"
    sudo chown -R pi:pi "$APP_DIR"

    echo "🐍 Δημιουργία Python virtual environment..."
    sudo apt update -y && sudo apt install -y python3 python3-venv python3-pip
    python3 -m venv venv
    source venv/bin/activate
    pip install --break-system-packages flask requests
    deactivate

    echo "⚙️  Δημιουργία systemd service..."
    sudo bash -c "cat > /etc/systemd/system/$SERVICE_NAME" <<EOF
[Unit]
Description=FD Alerts Flask Service on port $PORT
After=network.target

[Service]
Environment="PORT=$PORT"
WorkingDirectory=$APP_DIR
ExecStart=$APP_DIR/venv/bin/python $APP_DIR/app.py
Restart=always
User=pi

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reexec
    sudo systemctl daemon-reload
    sudo systemctl enable $SERVICE_NAME
    sudo systemctl restart $SERVICE_NAME

    sleep 2
    echo ""
    echo "✅ Εγκατάσταση ολοκληρώθηκε επιτυχώς!"
    echo "🌐 Άνοιξε: http://$(hostname -I | awk '{print $1}'):$PORT"
    echo ""

    if ! systemctl is-active --quiet $SERVICE_NAME; then
        echo "⚠️ Το service δεν ξεκίνησε σωστά. Δες τα τελευταία logs:"
        sudo journalctl -u $SERVICE_NAME -n 20 --no-pager
    fi
    exit 0
fi

echo "❌ Μη έγκυρη επιλογή. Έξοδος."
exit 1
