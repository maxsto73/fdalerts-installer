#!/bin/bash
# ======================================
# ðŸš€ FD Alerts Setup Utility
# ======================================

APP_DIR="/opt/fdalerts"
SERVICE_NAME="fdalerts.service"
REPO_BASE="https://raw.githubusercontent.com/maxsto73/fdalerts-installer/main"

clear
echo "======================================="
echo " ðŸš€ FD Alerts Setup Utility"
echo "    (Installer / Uninstaller / Update)"
echo "======================================="
echo ""

read -p "ðŸ‘‰ Î•Ï€Î¹Î»Î¿Î³Î® (1=Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·, 2=Î‘Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·, 3=Î•Ï€Î±Î½ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·): " CHOICE

case $CHOICE in

# ----------------------------------------------------------
# 1ï¸âƒ£ Î•Î“ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î—
# ----------------------------------------------------------
1)
    echo ""
    echo "ðŸ”§ ÎžÎµÎºÎ¹Î½Î¬ Î· ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· FD Alerts..."
    echo ""
    
    read -p "ðŸ”¢ Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ port (Ï€.Ï‡. 8899): " PORT
    if [ -z "$PORT" ]; then
        PORT=8899
        echo "âš ï¸ Î”ÎµÎ½ Î´ÏŒÎ¸Î·ÎºÎµ Ï„Î¹Î¼Î®, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î®: 8899"
    fi

    sudo mkdir -p "$APP_DIR"
    cd "$APP_DIR" || { echo "âŒ Î£Ï†Î¬Î»Î¼Î±: Î´ÎµÎ½ Î¼Ï€ÏŒÏÎµÏƒÎµ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸ÎµÎ¯ Î¿ Ï†Î¬ÎºÎµÎ»Î¿Ï‚ ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚."; exit 1; }

    echo "â¬‡ï¸  Î›Î®ÏˆÎ· ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚ Î±Ï€ÏŒ GitHub..."
    sudo curl -fsSL "$REPO_BASE/app.py" -o app.py || { echo "âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î»Î®ÏˆÎ·Ï‚ app.py"; exit 1; }

    echo "ðŸ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Python virtual environment..."
    sudo apt update -y && sudo apt install -y python3 python3-venv python3-pip
    python3 -m venv venv
    source venv/bin/activate
    pip install flask requests
    deactivate
    sudo chown -R pi:pi $APP_DIR
    echo "âš™ï¸  Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± systemd service..."
    sudo bash -c "cat > /etc/systemd/system/$SERVICE_NAME" <<EOF
[Unit]
Description=FD Alerts Flask Service on port $PORT
After=network.target

[Service]
Environment="PORT=$PORT"
WorkingDirectory=$APP_DIR
ExecStart=$APP_DIR/venv/bin/python $APP_DIR/app.py
Restart=always
User=pi

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reexec
    sudo systemctl daemon-reload
    sudo systemctl enable "$SERVICE_NAME"
    sudo systemctl restart "$SERVICE_NAME"

    sleep 2
    echo ""
    echo "âœ… Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏŽÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏŽÏ‚!"
    echo "ðŸŒ Î†Î½Î¿Î¹Î¾Îµ: http://$(hostname -I | awk '{print $1}'):$PORT"
    echo ""
    sudo systemctl status "$SERVICE_NAME" --no-pager -n 5
    ;;

# ----------------------------------------------------------
# 2ï¸âƒ£ Î‘Î Î•Î“ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î—
# ----------------------------------------------------------
2)
    echo ""
    echo "ðŸ§¹ Î‘Ï€ÎµÎ³ÎºÎ±Î¸Î¯ÏƒÏ„Î±Ï„Î±Î¹ FD Alerts..."

    sudo systemctl stop "$SERVICE_NAME" 2>/dev/null
    sudo systemctl disable "$SERVICE_NAME" 2>/dev/null
    sudo rm -f "/etc/systemd/system/$SERVICE_NAME"
    sudo systemctl daemon-reexec
    sudo systemctl daemon-reload

    if [ -d "$APP_DIR" ]; then
        sudo rm -rf "$APP_DIR"
    fi

    echo "âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏŽÎ¸Î·ÎºÎµ Î· Î±Ï€ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·."
    ;;

# ----------------------------------------------------------
# 3ï¸âƒ£ Î•Î Î‘ÎÎ•Î“ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î—
# ----------------------------------------------------------
3)
    echo ""
    echo "ðŸ” Î•Ï€Î±Î½ÎµÎ³ÎºÎ±Î¸Î¯ÏƒÏ„Î±Ï„Î±Î¹ FD Alerts..."
    sudo systemctl stop "$SERVICE_NAME" 2>/dev/null
    sudo rm -rf "$APP_DIR"
    sudo rm -f "/etc/systemd/system/$SERVICE_NAME"
    sudo systemctl daemon-reexec
    sudo systemctl daemon-reload
    bash <(curl -fsSL "$REPO_BASE/setup_fdalerts.txt")
    ;;

*)
    echo ""
    echo "âŒ ÎœÎ· Î­Î³ÎºÏ…ÏÎ· ÎµÏ€Î¹Î»Î¿Î³Î®. ÎˆÎ¾Î¿Î´Î¿Ï‚."
    ;;
esac
